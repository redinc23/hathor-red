# Deploy to Railway — fires only after a merge to main.
# Quality Gate (lint + tests + build) already passed on the PR before merge,
# so there is no need to re-run them here.
#
# Setup: add DEPLOY_HOOK secret (Railway → Settings → Deployments → Deploy Hook)

name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Railway deploy
        run: |
          if [ -n "${{ secrets.DEPLOY_HOOK }}" ]; then
            echo "Triggering Railway deploy..."
            curl -fsSL -X POST "${{ secrets.DEPLOY_HOOK }}"
          else
            echo "DEPLOY_HOOK not set — skipping trigger."
            echo "Add it in GitHub Secrets after connecting Railway."
          fi

      - name: Notify on failure
        if: failure()
        run: |
          if [ -n "${{ secrets.DEPLOY_WEBHOOK_URL }}" ]; then
            curl -s -X POST "${{ secrets.DEPLOY_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d "{\"text\": \"Deploy failed: ${{ github.repository }}\n${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}"
          fi
