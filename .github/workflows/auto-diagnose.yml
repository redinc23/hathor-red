# Auto-Diagnose — fires when Quality Gate fails on a PR.
#
# What it does:
#   1. Finds the PR associated with the triggering commit.
#   2. Fetches the failed job logs.
#   3. Posts a structured comment on the PR that names the failing job,
#      shows the relevant log tail, and suggests a fix.
#
# No external API keys required — only the built-in GITHUB_TOKEN.
# Permissions are read-only except for writing PR comments (pull-requests: write).

name: Auto-Diagnose Failures

on:
  workflow_run:
    workflows: ['Quality Gate']
    types: [completed]

jobs:
  diagnose:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write   # post comment
      actions: read          # read job logs
      contents: read

    steps:
      - name: Find associated PR
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO:     ${{ github.repository }}
          HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
        run: |
          PR_NUMBER=$(gh api "repos/$REPO/pulls" \
            --jq "[.[] | select(.head.sha==\"$HEAD_SHA\")] | first | .number // empty")
          echo "number=$PR_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Get failed jobs
        if: steps.pr.outputs.number != ''
        id: jobs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO:     ${{ github.repository }}
          RUN_ID:   ${{ github.event.workflow_run.id }}
        run: |
          FAILED=$(gh api "repos/$REPO/actions/runs/$RUN_ID/jobs" \
            --jq '[.jobs[] | select(.conclusion=="failure") | {name: .name, id: .id}]')
          echo "failed=$FAILED" >> "$GITHUB_OUTPUT"

      - name: Build and post diagnosis comment
        if: steps.pr.outputs.number != ''
        env:
          GH_TOKEN:   ${{ secrets.GITHUB_TOKEN }}
          REPO:       ${{ github.repository }}
          PR_NUMBER:  ${{ steps.pr.outputs.number }}
          FAILED:     ${{ steps.jobs.outputs.failed }}
          RUN_ID:     ${{ github.event.workflow_run.id }}
          RUN_URL:    ${{ github.event.workflow_run.html_url }}
          HEAD_SHA:   ${{ github.event.workflow_run.head_sha }}
        run: |
          SHORT_SHA="${HEAD_SHA:0:7}"

          # Build per-job sections
          SECTIONS=""
          JOB_COUNT=$(echo "$FAILED" | jq 'length')

          for i in $(seq 0 $((JOB_COUNT - 1))); do
            JOB_NAME=$(echo "$FAILED" | jq -r ".[$i].name")
            JOB_ID=$(echo "$FAILED"   | jq -r ".[$i].id")

            # Fetch last 60 lines of logs for this job
            LOG=$(gh api "repos/$REPO/actions/jobs/$JOB_ID/logs" 2>/dev/null \
              | tail -60 || echo "(log unavailable)")

            # Strip ANSI escape codes
            LOG=$(echo "$LOG" | sed 's/\x1b\[[0-9;]*m//g')

            HINT=""
            case "$JOB_NAME" in
              *Lint*)
                HINT="> **Suggested fix:** run \`make fmt\` locally to auto-fix, then re-commit." ;;
              *"Type Check"*)
                HINT="> **Suggested fix:** run \`pnpm run type-check\` locally and resolve the reported errors." ;;
              *Test*)
                HINT="> **Suggested fix:** run \`make test\` locally. If a snapshot changed, run \`jest --updateSnapshot\`." ;;
              *Build*)
                HINT="> **Suggested fix:** run \`pnpm install --frozen-lockfile && pnpm run build\` locally to reproduce the error." ;;
              *)
                HINT="> **Suggested fix:** check the logs above and reproduce locally before pushing." ;;
            esac

            SECTIONS="${SECTIONS}
          ### ❌ ${JOB_NAME}

          \`\`\`
          ${LOG}
          \`\`\`

          ${HINT}
          "
          done

          BODY="## CI Failure Report — \`${SHORT_SHA}\`

          **Workflow run:** [Quality Gate #${RUN_ID}](${RUN_URL})
          **Failed jobs:** ${JOB_COUNT}

          ${SECTIONS}

          ---
          *Auto-generated by [auto-diagnose.yml](.github/workflows/auto-diagnose.yml). Fix the issues above, push a new commit, and CI will re-run automatically.*"

          gh pr comment "$PR_NUMBER" \
            --repo "$REPO" \
            --body "$BODY"
